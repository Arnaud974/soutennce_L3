name: CI/CD - Django + React + GKE + Terraform

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # =======================================================
  # 1️⃣ CI BACKEND - Django (pytest)
  # =======================================================
  backend:
    runs-on: ubuntu-latest
    env:
      CI: true
      SECRET_KEY: test-secret
      EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
      EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install backend dependencies
        working-directory: ./backend
        run: pip install -r requirements.txt

      - name: Run migrations
        working-directory: ./backend
        run: python manage.py migrate

      - name: Run backend unit tests
        working-directory: ./backend
        run: pytest -m unit -v

      - name: Run backend integration tests
        working-directory: ./backend
        run: pytest -m integration -v

  # =======================================================
  # 2️⃣ CI FRONTEND - React (Vitest + Playwright)
  # =======================================================
  frontend:
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Serve for Playwright E2E tests
        working-directory: ./frontend
        run: npx serve -s dist -l 5173 &

      - name: Wait for frontend
        run: npx wait-on http://localhost:5173

      - name: Run unit tests
        working-directory: ./frontend
        run: npx vitest --run

      - name: Run E2E tests with Playwright
        working-directory: ./frontend
        run: npx playwright test --reporter=list,html

  # =======================================================
  # 3️⃣ CD - Build Docker images and deploy to GKE
  # =======================================================
  cd-deploy:
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    env:
      IMAGE_TAG: ${{ github.run_number }}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true  

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      # -------------------------------------------------
      # Build & Push Backend
      # -------------------------------------------------
      - name: Build backend image
        working-directory: ./backend
        run: |
          docker build -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/backend-app:${IMAGE_TAG} .

      - name: Push backend image
        run: |
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/backend-app:${IMAGE_TAG}

      # -------------------------------------------------
      # Build & Push Frontend
      # -------------------------------------------------
      - name: Build frontend image
        working-directory: ./frontend
        run: |
          docker build -t ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/frontend-app:${IMAGE_TAG} .

      - name: Push frontend image
        run: |
          docker push ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.GCP_REPOSITORY }}/frontend-app:${IMAGE_TAG}

      # -------------------------------------------------
      # Deploy to GKE
      # -------------------------------------------------
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ${{ secrets.GCP_CLUSTER_NAME }} \
          --zone ${{ secrets.GCP_CLUSTER_ZONE }} \
          --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Apply Kubernetes manifests
        working-directory: ./k8s
        run: |
          export IMAGE_TAG=${IMAGE_TAG}
          for file in $(find . -name '*-template.yaml'); do
            envsubst < $file > ${file/-template.yaml/.yaml}
          done
          kubectl apply -R -f .
